#!/bin/bash
set +e
# æ‰§è¡Œå‘½ä»¤å¹¶å°†ç»“æžœå­˜å‚¨åˆ°å˜é‡ä¸­

#åŽŸä½œè€…ï¼šé…·å®‰æ°´ç«¹é—²å£«x éƒ¨åˆ†By: JARK006
las=0
pre=1
las_num=-1
num=0
temp_file='/data/local/mem_app_test'
touch /data/local/mem_app_test0
touch /data/local/mem_app_test1
curr_index=$las
#echo -e "\e[?25"
echo -e "\e[93m"
echo -e "\e[2J"
echo -e "\033[1;5H\033[31;"
function necho(){
    #echo -e "\e[$2;1H$1"
    echo $1
}

function get_mem_info(){
    # èŽ·å–å†…å­˜ä¿¡æ¯
    mem_info=$(cat /proc/meminfo)
    
    # æå–æ€»å†…å­˜å¤§å°
    mem_total=$(echo "$mem_info" | grep "MemTotal" | awk '{print $2}')
    
    # æå–å¯ç”¨å†…å­˜å¤§å°
    mem_available=$(echo "$mem_info" | grep "MemAvailable" | awk '{print $2}')
    
    # è®¡ç®—å†…å­˜å ç”¨ç™¾åˆ†æ¯”
    mem_usage=$(awk "BEGIN {printf \"%.2f\", 100-($mem_available / $mem_total) * 100}")
}
function freezen_type()
{
echo "==============[ å†…å­˜ç®¡ç†çŠ¶æ€ ]=============="
    if [ $han1 = 'running' ]; then
        echo "âœ”ï¸å·²å¼€å¯ $ofreezeinfoå¢“ç¢‘"
    else
        echo "âŒæœªå¼€å¯ OFreezerå¢“ç¢‘"
    fi
    if [ -e /sys/fs/cgroup/uid_0/cgroup.freeze ]; then
        echo "âœ”ï¸å·²æŒ‚è½½ FreezerV2(UID)"
    else
        echo "âŒä¸æ”¯æŒ FreezerV2(UID)"
    fi
    
    if [[ -e /sys/fs/cgroup/frozen/cgroup.freeze ]] && [[ -e /sys/fs/cgroup/unfrozen/cgroup.freeze ]]; then
        echo "âœ”ï¸å·²æŒ‚è½½ FreezerV2(FROZEN)"
    else
        echo "âŒä¸æ”¯æŒ FreezerV2(frozen)"
    fi
    
    if [ -e /sys/fs/cgroup/freezer/perf/frozen/freezer.state ]; then
        echo "âœ”ï¸å·²æŒ‚è½½ FreezerV1(FROZEN)"
    fi
    
}
function get_power(){
    Battry_voltage=`cat /sys/class/power_supply/battery/voltage_now`
    Battery_currrnt=`cat /sys/class/power_supply/battery/current_now`
    ((Battry_voltage/=1000))
    ((power=Battery_currrnt*Battry_voltage/1000))
}

function update_mem_app_list(){
    if [ $curr_index -eq $las ];then
        curr_index=$pre
    else curr_index=$las
    fi
    ps_info_line=$(ps -ef -o uid,command,args | grep /system/bin/app_process64 | grep -v -e grep -e system_server -e : -e webview_zygote -e zygote64|awk '{print $1,$3}'|tee $temp_file$curr_index)
    #echo $ps_info
    uids=$(awk '{print $1}' $temp_file$curr_index)
    num=$(echo $uids|wc -w )
    status=$(ps -A  | grep -E "refrigerator|do_freezer|signal" | grep -v ':'| grep -v 'su'| awk '{print $6 " " $9}')
    status=${status//"__refrigerator"/"â„ï¸FreezerV1å†»ç»“ä¸­:"}
    status=${status//"do_freezer_trap"/"â„ï¸FreezerV2å†»ç»“ä¸­:"}
    status=${status//"do_signal_stop"/"ðŸ§ŠSIGSTOPå†»ç»“ä¸­:"}
    status=${status//"get_signal"/"â„ï¸ä¸å®Œæ•´V2å†»ç»“ä¸­:"}
    #echo "${#status}"
    fe=$(echo $status|wc -w )
    freezed=0
    ((freezed=fe/2))
}
function freezeinfov2()
{
    v1Info=$(mount | grep freezer | awk '{print "âœ”ï¸å·²æŒ‚è½½ FreezerV1: ",$3}')
    if [ ${#v1Info} -gt 2 ]; then
        echo "$v1Info"
    fi
    if [ ${#status} -gt 2 ]; then
echo "==============[ åº”ç”¨å†»ç»“çŠ¶æ€ ]==============
$status
"
    else
        echo "æš‚æ— å†»ç»“çŠ¶æ€çš„è¿›ç¨‹"
    fi
}
function freezeinfo()
{
    ps_info=($ps_info_line)
    i=0;
    j=1;
    size=${#ps_info[@]}
    while true; do
      
      #echo "${ps_info[@]}"
      line="${ps_info[$i]} ${ps_info[$j]}"
      #echo $line $i $j
      uid=$(echo "$line" | awk '{print $1}')
      name=$(echo "$line" | awk '{print $2}')
    
      freeze_file="/sys/fs/cgroup/uid_$uid/cgroup.freeze"
      freeze_value=$(cat "$freeze_file")
    
      if [ "$freeze_value" -eq 1 ] && [[ "$name" == com.tencent.* ]]; then
        echo "è…¾è®¯ç³»åº”ç”¨ï¼š$nameå¤„äºŽå†»ç»“ä¸­"
      fi
      if [ "$uid" -gt 10000 ]; then
        echo "$line æ˜¯ç¬¬ä¸‰æ–¹åº”ç”¨"
        echo 1 >$freeze_file
      fi
      i=$((i+2))
      j=$((j+2))
    if [ $j -gt $size ]; then
    break
    fi
    done
}
rm -rf ./mem_app.log
count=0
ofreezeinfo=$(grep module-version /data/oplus/os/bpm/sys_elsa_config_list.xml|/bin/awk -F'[<>]' '/<module-version>/ {getline; print $3}')
while
do
   # echo -e "\e[2J"
    #echo -e "\033[1;5H\033[31;"
    echo "###################" >>./mem_app.log
    han1=$(getprop init.svc.hans)
    han2=$(getprop persist.vendor.enable.hans)
    update_mem_app_list
    get_power
    get_mem_info
    sleep 1
    echo -e "\e[2J"
    echo -e "\033[1;5H\033[31;"
    freezen_type
    necho "å½“å‰å®žé™…åŠŸçŽ‡æ˜¯:$power mW" 5
    necho "MemAvailable: $((mem_available/1024)) MB"  6
    necho "å†…å­˜å ç”¨ç™¾åˆ†æ¯”: ${mem_usage}%" 7
    necho "å½“å‰appæ•°ä¸ºï¼š${num}" 8
    necho "å½“å‰è¢«å¢“ç¢‘APPæ•°ï¼š${freezed}" 11
    if [ ${#status} -gt 2 ]; then
echo "==============[ åº”ç”¨å†»ç»“çŠ¶æ€ ]==============
$status
"
    else
        echo "æš‚æ— å†»ç»“çŠ¶æ€çš„è¿›ç¨‹"
    fi
    
    diff_app=$(sort $temp_file$las $temp_file$pre | uniq -u)
    ((temp=num-count))
    echo "MemAvailable: $((mem_available/1024)) MB" >>./mem_app.log
    echo "å†…å­˜å ç”¨ç™¾åˆ†æ¯”: ${mem_usage}%" >>./mem_app.log
    echo "å½“å‰appæ•°ä¸ºï¼š${num}" >>./mem_app.log
    if [ $count -eq 0 ];then
        count=$num
        continue
    elif [ $temp -gt 0 ];then
        necho "æ–°å¢ž${temp}ä¸ªApp: " 9
        necho "${diff_app}" 10
        echo "æ–°å¢ž${temp}ä¸ªApp: " >>./mem_app.log
        echo ${diff_app} >>./mem_app.log
        count=${num}
        continue
    elif [ $temp -lt 0 ];then
        necho "å‡å°‘${temp}ä¸ªAppï¼š" 9
        necho "${diff_app}" 10
        echo "å‡å°‘${temp}ä¸ªAppï¼š" >>./mem_app.log
        echo ${diff_app} >>./mem_app.log
        count=${num}
    fi
    #freezeinfo
    #cat /sys/block/zram0/hybridswap_enable
done
